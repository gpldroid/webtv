<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAMI X-PRO | الحماية والتشغيل الذكي</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- تضمين ملف الإعدادات -->
    <script src="config.js"></script>
    
    <style>
        :root {
            --bg-body: #050505; 
            --bg-card: #121212; 
            --text-main: #ffffff;
            --accent-color: #d4af37; 
            --border-color: rgba(212, 175, 55, 0.15);
            --radius-card: 16px;
        }
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: sans-serif; 
            margin: 0; 
            padding-bottom: 60px; 
        }
        header { 
            background: var(--bg-card); 
            padding: 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 50; 
        }
        .player-wrapper { 
            background: #000; 
            width: 100%; 
            aspect-ratio: 16/9; 
        }
        .nav-tabs { 
            display: flex; 
            background: var(--bg-card); 
            margin: 15px; 
            border-radius: var(--radius-card); 
            padding: 5px; 
            gap: 5px; 
        }
        .mode-btn { 
            flex: 1; 
            padding: 12px; 
            font-size: 14px; 
            color: #aaa; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
        }
        .mode-btn.active { 
            color: var(--accent-color); 
            border-bottom: 2px solid var(--accent-color); 
        }
        .content-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 10px; 
            padding: 15px; 
        }
        .media-card { 
            background: var(--bg-card); 
            border-radius: 12px; 
            padding: 8px; 
            text-align: center; 
            border: 1px solid var(--border-color); 
            cursor: pointer; 
        }
        .media-logo { 
            width: 100%; 
            aspect-ratio: 1/1; 
            object-fit: cover; 
            border-radius: 8px; 
        }
        .cat-scroll-area { 
            display: flex; 
            overflow-x: auto; 
            gap: 8px; 
            padding: 10px; 
        }
        .cat-btn { 
            white-space: nowrap; 
            padding: 6px 15px; 
            border-radius: 20px; 
            background: var(--bg-card); 
            color: #fff; 
            border: 1px solid var(--border-color); 
            font-size: 12px; 
        }
        .cat-btn.active { 
            background: var(--accent-color); 
            color: #000; 
        }
    </style>
</head>
<body>
<div onclick="toggleAdminPanel()" style="position:fixed; bottom:10px; right:10px; z-index:1000; opacity:0.2; cursor:pointer;">
    <i class="fas fa-cog text-white"></i>
</div>

<div id="adminPanel" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#1a1a1a; width:100%; max-width:400px; padding:25px; border-radius:20px; border:1px solid #d4af37;">
        <h2 style="color:#d4af37; margin-bottom:20px; font-weight:bold;">إعدادات السيرفر</h2>
        
        <label class="block text-xs text-gray-400 mb-1">رابط السيرفر (Host)</label>
        <input id="set_base" type="text" class="w-full bg-black border border-gray-700 p-2 rounded mb-4 text-sm" placeholder="http://domain.com:port">
        
        <label class="block text-xs text-gray-400 mb-1">اسم المستخدم (User)</label>
        <input id="set_user" type="text" class="w-full bg-black border border-gray-700 p-2 rounded mb-4 text-sm">
        
        <label class="block text-xs text-gray-400 mb-1">كلمة المرور (Pass)</label>
        <input id="set_pass" type="password" class="w-full bg-black border border-gray-700 p-2 rounded mb-6 text-sm">
        
        <div class="flex gap-2">
            <button onclick="applySettings()" class="flex-1 bg-yellow-600 text-black font-bold py-2 rounded">حفظ التغييرات</button>
            <button onclick="toggleAdminPanel()" class="flex-1 bg-gray-800 text-white py-2 rounded">إلغاء</button>
        </div>
        <button onclick="resetSettings()" class="w-full mt-4 text-xs text-red-500 opacity-50">استعادة الإعدادات الأصلية</button>
    </div>
</div>
<header>
    <span style="color:var(--accent-color); font-weight:bold;" id="appName">DAMI X-PRO</span>
    <div id="status" class="text-xs opacity-50">متصل</div>
</header>

<div class="player-wrapper">
    <video id="player" playsinline controls crossorigin></video>
</div>

<div class="nav-tabs">
    <button onclick="switchMode('get_live_streams', 'get_live_categories', this)" class="mode-btn active">مباشر</button>
    <button onclick="switchMode('get_vod_streams', 'get_vod_categories', this)" class="mode-btn">أفلام</button>
    <button onclick="switchMode('get_series', 'get_series_categories', this)" class="mode-btn">مسلسلات</button>
</div>

<div id="catsWrapper" class="cat-scroll-area"></div>
<main id="contentGrid" class="content-grid"></main>

<script>
    // استخدام الإعدادات من الملف الخارجي
    const config = ServerConfig;
    
    // أو استخدام الكلاس (اختر الطريقة التي تفضلها)
    // const iptvConfig = new IPTVConfig();
    
    const PROXY = config.Security.proxyUrl;
    let fullData = [], currentMode = 'get_live_streams';
    
    // إعداد المشغل
    const video = document.getElementById('player');
    const player = new Plyr(video, { 
        captions: { active: true, update: true },
        autoplay: config.Player.autoplay
    });
    const hls = new Hls();
    
    // تعيين اسم التطبيق من الإعدادات
    document.getElementById('appName').textContent = config.UI.appName;

    // حظر المتصفحات غير المدعومة
    if (config.Security.blockChrome) {
        const isChrome = /Chrome/.test(navigator.userAgent) && 
                       /Google Inc/.test(navigator.vendor) && 
                       !/Edg/.test(navigator.userAgent);
        
        const isAllowed = config.Security.allowedBrowsers.some(browser => 
            navigator.userAgent.toLowerCase().includes(browser)
        );
        
        if (isChrome && !isAllowed) {
            document.body.innerHTML = `
                <div style="height:100vh; display:flex; align-items:center; justify-content:center; background:#000; color:#d4af37; text-align:center; padding:20px;">
                    <div>
                        <h1>⚠️ متصفح غير مدعوم</h1>
                        <p>عذراً، تطبيق ${config.UI.appName} لا يعمل على جوجل كروم.</p>
                        <p>يرجى استخدام ${config.Security.allowedBrowsers.join(' أو ')}.</p>
                    </div>
                </div>
            `;
            window.stop();
        }
    }

    // دالة جلب البيانات مع إضافة الـProxy إذا كان مفعلاً
    async function fetchData(url) {
        try {
            const finalUrl = config.Security.proxyEnabled ? 
                PROXY + encodeURIComponent(url) : url;
            
            const res = await fetch(finalUrl);
            
            if (config.Security.proxyEnabled) {
                const data = await res.json();
                return JSON.parse(data.contents);
            } else {
                return await res.json();
            }
        } catch (e) { 
            console.error("خطأ في جلب البيانات:", e);
            return []; 
        }
    }

    // إنشاء URL للـAPI
    function createApiUrl(action, categoryId = null) {
        let url = `${config.API.base}/player_api.php?username=${config.API.user}&password=${config.API.pass}&action=${action}`;
        if (categoryId && categoryId !== 'all') {
            url += `&category_id=${categoryId}`;
        }
        return url;
    }

    // إنشاء رابط البث
    function createStreamUrl(type, streamId, extension = "m3u8") {
        if (type === "live") {
            return `${config.API.base}/live/${config.API.user}/${config.API.pass}/${streamId}.${extension}`;
        } else if (type === "movie") {
            return `${config.API.base}/movie/${config.API.user}/${config.API.pass}/${streamId}.${extension}`;
        } else if (type === "series") {
            return `${config.API.base}/series/${config.API.user}/${config.API.pass}/${streamId}.${extension}`;
        }
    }

    async function switchMode(action, catAction, btn) {
        currentMode = action;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // جلب التصنيفات
        const categoriesUrl = createApiUrl(catAction);
        const cats = await fetchData(categoriesUrl);
        
        const container = document.getElementById('catsWrapper');
        container.innerHTML = `<button onclick="loadContent('all')" class="cat-btn active">الكل</button>`;
        
        if (cats && cats.length > 0) {
            cats.forEach(cat => {
                const b = document.createElement('button');
                b.className = "cat-btn";
                b.innerText = cat.category_name;
                b.onclick = () => {
                    document.querySelectorAll('.cat-btn').forEach(c => c.classList.remove('active'));
                    b.classList.add('active');
                    loadContent(cat.category_id);
                };
                container.appendChild(b);
            });
        }
        
        loadContent('all');
    }

    async function loadContent(catId) {
        const grid = document.getElementById('contentGrid');
        grid.innerHTML = "جاري التحميل...";
        
        const url = createApiUrl(currentMode, catId);
        fullData = await fetchData(url);
        
        if (fullData && fullData.length > 0) {
            // تحديد عدد العناصر حسب الإعدادات
            const itemsToShow = fullData.slice(0, config.UI.maxItemsPerPage || 50);
            
            grid.innerHTML = itemsToShow.map(item => `
                <div class="media-card" onclick="playMedia(
                    '${item.stream_id || item.series_id || item.vod_id}', 
                    '${item.container_extension || 'mp4'}',
                    '${item.name || 'بدون عنوان'}'
                )">
                    <img src="${item.stream_icon || item.cover || config.UI.logoUrl}" 
                         class="media-logo" 
                         loading="lazy"
                         onerror="this.src='${config.UI.logoUrl}'">
                    <p class="text-[10px] mt-2 truncate">${item.name || 'بدون عنوان'}</p>
                </div>
            `).join('');
        } else {
            grid.innerHTML = `<div class="col-span-full text-center py-10">لا توجد محتويات</div>`;
        }
    }

    function playMedia(id, ext, title = '') {
        let type = "live"; 
        if (currentMode === 'get_vod_streams') type = "movie";
        if (currentMode === 'get_series') type = "series";
        
        // تحديث العنوان في الـheader
        if (title) {
            document.getElementById('status').innerHTML = 
                `<span class="truncate max-w-[150px] inline-block">${title}</span>`;
        }
        
        // تحديد الامتداد بناءً على النوع
        let finalExt = (currentMode === 'get_live_streams') ? "m3u8" : (ext || "mp4");
        const streamUrl = createStreamUrl(type, id, finalExt);
        
        console.log("جارٍ تشغيل:", streamUrl);
        
        // تنظيف المشغل قبل البدء
        hls.detachMedia();
        video.pause();
        video.src = "";
        
        if (finalExt === 'm3u8') {
            if (Hls.isSupported()) {
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = streamUrl;
                video.play();
            }
        } else {
            // تشغيل الأفلام والمسلسلات
            video.src = streamUrl;
            video.play().catch(e => {
                console.error("خطأ في التشغيل:", e);
                alert("هذا المتصفح قد لا يدعم صيغة الفيديو هذه، جرب متصفحاً آخر.");
            });
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // بدء التطبيق عند التحميل
    window.onload = () => {
        switchMode('get_live_streams', 'get_live_categories', document.querySelector('.mode-btn'));
    };
</script>
</body>
</html>
